name: ci

on:
  pull_request: {}
  push:
    branches:
      - master

jobs:

  commitsar:
    name: Verify commit messages
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v1
      - name: Run commitsar
        uses: docker://commitsar/commitsar

  pre-commit:
    name: Generic pre-commit checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 1

      - uses: actions/setup-python@v2
        with:
          python-version: 3.7

      - run: pip install pre-commit
      - run: SKIP=fmt,cargo-check,clippy pre-commit run --all-files

  test-stable:
    name: Test (stable)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true

      - uses: actions/setup-python@v2
        with:
          python-version: 3.7

      - name: Start background server
        run: |
          python -m pip install flask
          # Starts the server in background
          python ./css-inline/tests/server.py &

      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      - run: cargo test --no-fail-fast
        working-directory: ./css-inline

  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
          components: rustfmt
      - run: cargo fmt --all -- --check
        working-directory: ./css-inline

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
          components: clippy
      - run: cargo clippy -- -D warnings
        working-directory: ./css-inline

  test-python:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.6', '3.7', '3.8', '3.9', '3.10']

    name: Python ${{ matrix.python-version }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true
      - uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}
          architecture: x64

      - run: python -m pip install tox
        working-directory: ./bindings/python

      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Run ${{ matrix.python }} tox job
        run: tox -e py
        working-directory: ./bindings/python

  test-python-sdist:
    runs-on: ubuntu-latest
    name: Testing Python source code distribution
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true
      - uses: actions/setup-python@v2
        with:
          python-version: '3.8'
          architecture: x64

      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - run: python -m pip install tox
        working-directory: ./bindings/python

      - run: tox -e build-sdist
        working-directory: ./bindings/python

      - name: Installing sdist
        run: pip install dist/*
        working-directory: ./bindings/python

  test-wasm:
    name: Tests for WASM crate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      - name: Install wasm-pack
        uses: actions-rs/cargo@v1
        with:
          command: install
          args: wasm-pack
      - name: Run tests
        run: wasm-pack test --node
        # Weird wasm-pack error: https://github.com/rustwasm/wasm-pack/issues/743
        # It works locally with the same wasm-pack & dependencies versions
        continue-on-error: true
        working-directory: ./bindings/wasm

  test-wasm-typescript:
    name: TypeScript tests for WASM crate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      - name: Install wasm-pack
        uses: actions-rs/cargo@v1
        with:
          command: install
          args: wasm-pack
      - name: Build package
        run: wasm-pack build -t nodejs
        working-directory: ./bindings/wasm
      - name: Install dependencies
        run: npm install
        working-directory: ./bindings/wasm
      - name: Run tests
        run: npm run test
        # Affected by https://github.com/rustwasm/wasm-pack/issues/743
        # Which is caused by `parking_lot` and should be fixed by https://github.com/Amanieu/parking_lot/pull/302
        continue-on-error: true
        working-directory: ./bindings/wasm

  build_wheels:
    name: Build wheels on ${{ matrix.os }}  - ${{ matrix.vers }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - vers: i686
            os: ubuntu-20.04
          - vers: aarch64
            os: ubuntu-20.04
          - vers: auto64
            os: ubuntu-20.04
          - vers: auto64
            os: macos-10.15
          - vers: auto64
            os: windows-2019

    env:
      SCCACHE_VERSION: 0.2.13
      CIBW_BEFORE_ALL_LINUX: "curl https://sh.rustup.rs -sSf | sh -s -- --default-toolchain stable -y && yum install -y openssl-devel"
      CIBW_BUILD_VERBOSITY: "1"
      CIBW_ENVIRONMENT: 'PATH="$PATH:$HOME/.cargo/bin"'
      CIBW_SKIP: "cp27-* cp34-* cp35-* pp* *-win32"

    steps:
      - uses: actions/checkout@v2

      - uses: actions/setup-python@v2
        name: Install Python
        with:
          python-version: "3.8"

      - name: Set up QEMU
        if: runner.os == 'Linux'
        uses: docker/setup-qemu-action@v1
        with:
          platforms: all

      - name: wheels Linux ${{ matrix.vers }}
        if: runner.os == 'Linux'
        uses: joerick/cibuildwheel@v2.3.1
        env:
          CIBW_ARCHS_LINUX: ${{ matrix.vers }}
        with:
          package-dir: bindings/python

      - name: wheels Macos ${{ matrix.vers }}
        if: runner.os == 'Macos'
        uses: joerick/cibuildwheel@v2.3.1
        env:
          ARCHFLAGS: "x86_64 arm64"
          CIBW_BEFORE_ALL: "rustup target add aarch64-apple-darwin"
          CIBW_SKIP: "cp27-* cp34-* cp35-* cp36-* cp37-* pp* *-win32"
          CIBW_ARCHS_MACOS: ${{ matrix.vers }}
        with:
          package-dir: bindings/python

      - name: wheels Windows ${{ matrix.vers }}
        if: runner.os == 'Windows'
        uses: joerick/cibuildwheel@v2.3.1
        env:
          CIBW_ARCHS_WINDOWS: ${{ matrix.vers }}
        with:
          package-dir: bindings/python

      - uses: actions/upload-artifact@v2
        with:
          path: ./wheelhouse/*.whl
