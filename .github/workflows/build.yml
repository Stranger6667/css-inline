name: ci

on:
  pull_request: {}
  push:
    branches:
      - master

jobs:

  wheels-macos-universal:
    # `cibuildwheel` does not support building CPython 3.6/3.7 wheels for macOS ARM64
    # This job build universal wheel that covers these versions.
    # Non-universal wheels are also in place, because they have smaller size & will be used in Python 3.8+ installations
    name: "Wheels for macOS universal2"
    runs-on: macos-11
    steps:
      - uses: actions/checkout@v2
      - name: Setup python
        run: |
          curl "$PYTHON_DOWNLOAD_URL" -o python.pkg
          sudo installer -pkg python.pkg -target /
        env:
          PYTHON_DOWNLOAD_URL: 'https://www.python.org/ftp/python/3.10.0/python-3.10.0post2-macos11.pkg'
      - uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
          default: true
          target: aarch64-apple-darwin
      - run: /Library/Frameworks/Python.framework/Versions/3.10/bin/python3 -m venv venv
      - run: venv/bin/pip install -U pip wheel setuptools-rust
      - run: mkdir wheelhouse
      - name: Build the wheel
        run: |
          cd bindings/python && \
          ../../venv/bin/python setup.py bdist_wheel --py-limited-api=cp36 && \
          mv dist/css_inline*.whl ../../wheelhouse
        env:
          MACOSX_DEPLOYMENT_TARGET: '10.10'
          ARCHFLAGS: '-arch x86_64 -arch arm64'
          _PYTHON_HOST_PLATFORM: 'macosx-10.9-universal2'
      - run: venv/bin/pip install -f wheelhouse --no-index css_inline
      - run: find venv/lib/*/site-packages/ -name 'css_inline*.so' -exec vtool -show {} \;
      - uses: actions/upload-artifact@v2
        with:
          name: Distribution Artifacts
          path: wheelhouse/*.whl
